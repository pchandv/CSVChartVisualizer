<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Call Line Graph</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #f8f9fa;
        }
        .chart-container {
            position: relative;
            width: 90%;
            max-width: 1200px;
            height: 600px;
            margin: auto;
            background: white;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
        }
        input {
            margin: 10px;
            padding: 5px;
            width: 200px;
        }
    </style>
</head>
<body>
    <h2>Service Calls Over Time</h2>
    <input type="text" id="search" placeholder="Search data..." onkeyup="filterData()">
    <input type="date" id="dateFilter" onchange="filterData()">
    <input type="file" id="fileUpload" accept=".csv" onchange="handleFileUpload(event)">
    <div class="chart-container">
        <canvas id="lineGraph"></canvas>
    </div>
    <script>
        function filterData() {
            let searchTerm = document.getElementById('search').value.toLowerCase();
            let selectedDate = document.getElementById('dateFilter').value;
            let filteredData = JSON.parse(JSON.stringify(originalData));

            filteredData.datasets = filteredData.datasets.filter(dataset => dataset.label.toLowerCase().includes(searchTerm));
            
            if (selectedDate) {
                let filteredIndexes = originalData.labels.map((label, index) => label.startsWith(selectedDate) ? index : -1).filter(index => index !== -1);
                filteredData.labels = filteredIndexes.map(index => originalData.labels[index]);
                filteredData.datasets.forEach(dataset => {
                    dataset.data = filteredIndexes.map(index => dataset.data[index]);
                });
            }
            
            if (filteredData.datasets.length === 0) {
                filteredData.labels = [];
            }
            lineGraph.data = filteredData;
            lineGraph.update();
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file || !file.name.endsWith('.csv')) {
                alert('Invalid file format. Please upload a CSV file.');
                return;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                const rows = e.target.result.trim().split('\n').map(row => row.split(','));
                if (rows.length < 2) {
                    alert('Invalid CSV format. The file must contain at least two rows.');
                    return;
                }
                updateChart(rows.slice(1)); // Ignore header row, process from second row
            };
            reader.readAsText(file);
        }

        function updateChart(rows) {
            let newLabels = [];
            let newDatasets = {};
            for (let i = 0; i < rows.length; i++) {
                let [date, service, calls] = rows[i];
                if (!date || !service || isNaN(calls)) continue;
                if (!newLabels.includes(date)) newLabels.push(date);
                if (!newDatasets[service]) newDatasets[service] = [];
                newDatasets[service].push(parseInt(calls));
            }
            let updatedDatasets = Object.keys(newDatasets).map((service, index) => ({
                label: service,
                data: newDatasets[service],
                borderColor: ['red', 'green', 'blue', 'purple', 'orange'][index % 5],
                backgroundColor: 'rgba(0, 0, 0, 0.1)',
                fill: false,
                tension: 0.2,
                pointRadius: 4,
                borderWidth: 2
            }));
            
            originalData.labels = newLabels;
            originalData.datasets = updatedDatasets;
            
            lineGraph.data.labels = newLabels;
            lineGraph.data.datasets = updatedDatasets;
            lineGraph.update();
        }

        let originalData = {
            labels: [],
            datasets: []
        };

        const lineGraph = new Chart(document.getElementById('lineGraph').getContext('2d'), {
            type: 'line',
            data: JSON.parse(JSON.stringify(originalData)),
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        title: { display: true, text: 'Request Date' }
                    },
                    y: {
                        title: { display: true, text: 'Total Calls' }
                    }
                },
                plugins: {
                    legend: { labels: { usePointStyle: true, boxWidth: 15 } },
                    zoom: {
                        pan: { enabled: true, mode: 'x' },
                        zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' }
                    }
                }
            }
        });
    </script>
</body>
</html>
